<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AttendWise — Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--muted:#9ca3af;--accent:#3b82f6;--text:#e6eef8}
    html.light{--bg:#f3f4f6;--card:#fff;--muted:#6b7280;--text:#111827}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);min-height:100vh;margin:0}
    .card{background:var(--card)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
    #video,#overlay{position:absolute;top:0;left:0}
    .btn{padding:.5rem .75rem;border-radius:.375rem}
    .small{font-size:.85rem}
  </style>
</head>
<body>
  <main id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <section class="max-w-md w-full card rounded-lg p-8 shadow-lg">
      <div class="text-center">
        <div class="mx-auto w-12 h-12 rounded-full flex items-center justify-center bg-blue-500 text-white"><i class="fas fa-user-check"></i></div>
        <h1 class="mt-4 text-2xl font-semibold">AttendWise — Admin</h1>
        <p class="text-sm" id="login-sub">Secure admin login</p>
      </div>
      <form id="login-form" class="mt-6 space-y-4" aria-label="Admin login form">
        <label class="sr-only" for="username">Username</label>
        <input id="username" name="username" required class="w-full p-3 rounded bg-[color:inherit]" placeholder="Username">
        <div class="relative">
          <label class="sr-only" for="password">Password</label>
          <input id="password" name="password" type="password" required class="w-full p-3 rounded bg-[color:inherit]" placeholder="Password">
          <button id="password-toggle" type="button" class="absolute right-2 top-2 text-muted" aria-label="Toggle password visibility"><i class="fas fa-eye"></i></button>
        </div>
        <p id="login-error" class="text-sm text-red-400 h-5"></p>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-[color:var(--accent)] text-white p-3 rounded font-semibold">Sign in</button>
          <button id="reset-creds" type="button" class="flex-1 bg-gray-600 text-white p-3 rounded small">Reset creds</button>
        </div>
      </form>
    </section>
  </main>

  <div id="app" class="hidden min-h-screen flex">
    <aside class="hidden md:flex flex-col w-20 p-4 gap-6 items-center justify-between card">
      <div class="space-y-6 text-center text-[color:var(--accent)]">
        <i class="fas fa-user-shield fa-2x"></i>
      </div>
      <nav class="flex flex-col gap-6" aria-label="Main nav">
        <a href="#" class="nav-item" data-page="dashboard" title="Dashboard"><i class="fas fa-th-large fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="clock" title="Clock In/Out"><i class="fas fa-camera fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="users" title="Students"><i class="fas fa-users-cog fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="logs" title="Logs"><i class="fas fa-clipboard-list fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="settings" title="Settings"><i class="fas fa-cog fa-lg"></i></a>
      </nav>
      <div class="flex flex-col items-center gap-4">
        <button id="logout" class="text-muted" title="Logout"><i class="fas fa-sign-out-alt fa-lg"></i></button>
        <button id="theme-toggle" title="Toggle theme"><i id="theme-icon" class="fas fa-moon"></i></button>
      </div>
    </aside>

    <main id="main" class="flex-1 p-6 md:p-10 overflow-auto"></main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around z-40 card">
      <a href="#" class="nav-item" data-page="dashboard"><i class="fas fa-th-large"></i></a>
      <a href="#" class="nav-item" data-page="clock"><i class="fas fa-camera"></i></a>
      <a href="#" class="nav-item" data-page="users"><i class="fas fa-users-cog"></i></a>
      <a href="#" class="nav-item" data-page="logs"><i class="fas fa-clipboard-list"></i></a>
      <a href="#" class="nav-item" data-page="settings"><i class="fas fa-cog"></i></a>
    </nav>
  </div>

  <div id="loading" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 z-50">
    <div class="p-6 rounded shadow-lg card text-center">
      <div class="loader mb-4" style="width:48px;height:48px;border:6px solid #ddd;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite"></div>
      <h3 id="loading-title" class="font-semibold">Loading</h3>
      <p id="loading-sub" class="text-sm"></p>
    </div>
  </div>

  <div id="pin-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="card rounded p-6 w-full max-w-sm">
      <h3 class="text-lg font-semibold text-center">Verify Roll Number</h3>
      <p class="text-center text-sm">Face recognized: <strong id="pin-name"></strong></p>
      <form id="pin-form" class="mt-4">
        <input id="pin" inputmode="numeric" autocomplete="one-time-code" class="w-full p-3 rounded text-center text-xl bg-[color:inherit]" placeholder="Enter roll number" required>
        <p id="pin-err" class="text-sm text-red-400 h-5 mt-2"></p>
        <div class="mt-4 flex gap-3">
          <button type="button" id="pin-cancel" class="flex-1 p-2 rounded bg-gray-600 text-white">Cancel</button>
          <button type="submit" class="flex-1 p-2 rounded bg-[color:var(--accent)] text-white">Verify</button>
        </div>
      </form>
    </div>
  </div>

  <div id="alert" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="card rounded p-6 w-full max-w-sm text-center">
      <h3 id="alert-title" class="font-semibold text-lg"></h3>
      <p id="alert-msg" class="text-sm mt-2"></p>
      <div class="mt-4"><button id="alert-ok" class="p-2 rounded bg-[color:var(--accent)] text-white w-1/2">OK</button></div>
    </div>
  </div>

  <div id="confirm" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="card rounded p-6 w-full max-w-sm text-center">
      <h3 id="confirm-title" class="font-semibold text-lg">Confirm</h3>
      <p id="confirm-msg" class="text-sm mt-2"></p>
      <div class="mt-4 flex gap-3">
        <button id="confirm-no" class="flex-1 p-2 rounded bg-gray-600 text-white">Cancel</button>
        <button id="confirm-yes" class="flex-1 p-2 rounded bg-red-600 text-white">Confirm</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   STATE & STORAGE
   ============================ */
const STATE = {
  users: [], // {id,name,roll,image,descriptor(Array)}
  attendance: [], // {id,name,subject,date,time,status}
  faceMatcher: null,
  modelsLoaded: false,
  recogInterval: null,
  verifying: false,
  pendingUser: null,
  cooldownMap: new Map() // key: name|subject -> timestamp
};
const DBKEY = 'attendwise_final_v1';

/* ---------- Elements ---------- */
const els = {
  loginScreen: document.getElementById('login-screen'),
  app: document.getElementById('app'),
  main: document.getElementById('main'),
  loading: document.getElementById('loading'),
  loadingTitle: document.getElementById('loading-title'),
  loadingSub: document.getElementById('loading-sub'),
  pinModal: document.getElementById('pin-modal'),
  pinName: document.getElementById('pin-name'),
  pinForm: document.getElementById('pin-form'),
  pinInput: document.getElementById('pin'),
  pinErr: document.getElementById('pin-err'),
  pinCancel: document.getElementById('pin-cancel'),
  alert: document.getElementById('alert'),
  alertTitle: document.getElementById('alert-title'),
  alertMsg: document.getElementById('alert-msg'),
  alertOk: document.getElementById('alert-ok'),
  confirm: document.getElementById('confirm'),
  confirmMsg: document.getElementById('confirm-msg'),
  confirmYes: document.getElementById('confirm-yes'),
  confirmNo: document.getElementById('confirm-no')
};

/* ---------- Helpers: Storage ---------- */
function loadDB(){
  const raw = localStorage.getItem(DBKEY);
  if(!raw) {
    STATE.users = [];
    STATE.attendance = [];
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    STATE.users = parsed.users || [];
    STATE.attendance = parsed.attendance || [];
    // ensure descriptors are arrays (they are stored as arrays)
  }catch(e){
    STATE.users = [];
    STATE.attendance = [];
  }
}
function saveDB(){
  localStorage.setItem(DBKEY, JSON.stringify({users: STATE.users, attendance: STATE.attendance}));
}

/* ========== Initialization ========== */
document.addEventListener('DOMContentLoaded', async ()=>{
  initCreds();
  attachStaticListeners();
  loadDB();
  await loadModels();
  rebuildMatcher();
  checkAuthAndShow();
  showPage('dashboard');
  setInterval(()=>{ const lc = document.getElementById('live-clock'); if(lc) lc.textContent = new Date().toLocaleTimeString(); }, 1000);
});

/* ---------- Admin Creds ---------- */
function initCreds(){
  if(!localStorage.getItem('adminUser')) localStorage.setItem('adminUser','admin');
  if(!localStorage.getItem('adminPass')) localStorage.setItem('adminPass','admin123');
}

/* ---------- UI & Navigation ---------- */
function attachStaticListeners(){
  document.getElementById('login-form').addEventListener('submit', handleLogin);
  document.getElementById('password-toggle').addEventListener('click', ()=>{
    const p = document.getElementById('password'), i = document.querySelector('#password-toggle i');
    if(p.type==='password'){ p.type='text'; i.classList.replace('fa-eye','fa-eye-slash'); } else { p.type='password'; i.classList.replace('fa-eye-slash','fa-eye'); }
  });
  document.querySelectorAll('.nav-item').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); showPage(a.dataset.page); }));
  document.getElementById('logout').addEventListener('click', handleLogout);
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  document.getElementById('reset-creds').addEventListener('click', ()=> {
    localStorage.setItem('adminUser','admin'); localStorage.setItem('adminPass','admin123'); showAlert('Reset','Credentials reset to admin/admin123');
  });

  els.pinCancel.addEventListener('click', cancelPin);
  els.pinForm.addEventListener('submit', submitPin);
  els.alertOk.addEventListener('click', ()=> els.alert.classList.add('hidden'));
  els.confirmNo.addEventListener('click', ()=> closeConfirm(false));
  els.confirmYes.addEventListener('click', ()=> closeConfirm(true));
}

/* ---------- Login Logic ---------- */
function handleLogin(e){
  e.preventDefault();
  const u = e.target.username.value.trim();
  const p = e.target.password.value;
  if(u === localStorage.getItem('adminUser') && p === localStorage.getItem('adminPass')){
    localStorage.setItem('isLoggedIn','true');
    checkAuthAndShow();
    e.target.reset();
  } else {
    const err = document.getElementById('login-error'); err.textContent = 'Invalid credentials'; setTimeout(()=>err.textContent='',2000);
  }
}
function checkAuthAndShow(){
  if(localStorage.getItem('isLoggedIn') === 'true'){ els.loginScreen.classList.add('hidden'); els.app.classList.remove('hidden'); }
  else { els.loginScreen.classList.remove('hidden'); els.app.classList.add('hidden'); }
}
function handleLogout(){
  stopRecognition(); localStorage.removeItem('isLoggedIn'); checkAuthAndShow(); showPage('dashboard');
}

/* ---------- Alerts/Confirm ---------- */
function showAlert(title,msg){
  els.alertTitle.textContent = title; els.alertMsg.textContent = msg; els.alert.classList.remove('hidden');
}
let confirmResolver = null;
function showConfirm(msg){
  els.confirmMsg.textContent = msg; els.confirm.classList.remove('hidden');
  return new Promise(res => { confirmResolver = res; });
}
function closeConfirm(answer){
  els.confirm.classList.add('hidden'); if(confirmResolver) confirmResolver(answer); confirmResolver = null;
}

/* ---------- Loading UI ---------- */
function showLoading(title, sub=''){ els.loadingTitle.textContent = title; els.loadingSub.textContent = sub; els.loading.classList.remove('hidden'); }
function hideLoading(){ els.loading.classList.add('hidden'); }

/* ========= Face API Models & Matcher ========= */
const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';

async function loadModels(){
  try{
    showLoading('Loading models','This may take 10-20 seconds first time');
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
    ]);
    STATE.modelsLoaded = true;
  }catch(e){
    console.error('model load', e);
    showAlert('Model error','Could not load face models. Check network.');
  } finally { hideLoading(); }
}

function rebuildMatcher(){
  if(!STATE.users || STATE.users.length===0){ STATE.faceMatcher = null; return; }
  try{
    const labeled = STATE.users.map(u => {
      const arr = new Float32Array(u.descriptor);
      return new faceapi.LabeledFaceDescriptors(u.name, [arr]);
    });
    STATE.faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
  }catch(e){
    console.error('matcher', e);
    STATE.faceMatcher = null;
  }
}

/* ========= Pages: Templates & Setup ========= */
const templates = {
  dashboard: () => {
    const today = new Date().toISOString().slice(0,10);
    const presentSet = new Set(STATE.attendance.filter(a=>a.date===today).map(a=>a.name));
    const total = STATE.users.length;
    const present = presentSet.size;
    const absent = Math.max(0, total - present);
    return `
      <div>
        <div class="flex justify-between items-center mb-6">
          <div><h2 class="text-2xl font-semibold">Dashboard</h2><p id="today-date" class="text-sm">${new Date().toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p></div>
          <div id="live-clock" class="font-medium">${new Date().toLocaleTimeString()}</div>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="card p-4 rounded"><h4 class="text-sm">Total Students</h4><div class="text-2xl font-bold">${total}</div></div>
          <div class="card p-4 rounded"><h4 class="text-sm">Present Today</h4><div class="text-2xl font-bold">${present}</div></div>
          <div class="card p-4 rounded"><h4 class="text-sm">Absent Today</h4><div class="text-2xl font-bold">${absent}</div></div>
        </div>
        <div class="card p-4 rounded mt-4">
          <h4 class="font-semibold mb-2">Recent Activity</h4>
          <div id="recent-list" class="text-sm">${STATE.attendance.filter(a=>a.date===today).slice(-8).reverse().map(r=>`<div class="flex justify-between"><div><strong>${r.name}</strong><div class="text-xs text-[color:var(--muted)]">${r.subject}</div></div><div class="text-sm">${r.time}</div></div>`).join('') || '<div class="text-[color:var(--muted)]">No activity today</div>'}</div>
        </div>
      </div>
    `;
  },

  users: () => {
    return `
      <div>
        <h2 class="text-2xl font-semibold mb-4">Manage Students</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="card p-4 rounded">
            <h3 class="font-semibold mb-2">Add Student</h3>
            <form id="add-user-form" class="space-y-3">
              <input id="name" placeholder="Name" class="w-full p-2 rounded bg-[color:inherit]" required>
              <input id="roll" placeholder="Roll Number" class="w-full p-2 rounded bg-[color:inherit]" required>
              <div class="flex gap-2">
                <input id="file-image" type="file" accept="image/*" class="flex-1">
                <button id="capture-btn" type="button" class="btn bg-[color:var(--accent)] text-white">Webcam</button>
              </div>
              <div id="capture-area" class="hidden mt-2 relative" style="padding-top:56%;border-radius:8px;overflow:hidden;background:var(--card)">
                <video id="capture-video" autoplay muted playsinline style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover"></video>
                <canvas id="capture-canvas" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
                <div class="absolute bottom-2 left-2 right-2 flex gap-2">
                  <button id="snap" type="button" class="flex-1 btn bg-green-600 text-white">Snap</button>
                  <button id="stop-capture" type="button" class="flex-1 btn bg-gray-600 text-white">Stop</button>
                </div>
              </div>
              <button id="add-btn" class="w-full p-2 rounded bg-[color:var(--accent)] text-white" type="submit">Add Student</button>
            </form>
          </section>

          <section class="card p-4 rounded">
            <h3 class="font-semibold mb-2">Registered Students</h3>
            <div id="user-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-auto"></div>
            <div class="mt-3 flex gap-2">
              <button id="export-db" class="flex-1 btn bg-green-600 text-white">Export JSON</button>
              <button id="import-db" class="flex-1 btn bg-yellow-600 text-white">Import JSON</button>
              <input id="import-file" type="file" accept="application/json" class="hidden">
            </div>
          </section>
        </div>
      </div>
    `;
  },

  logs: () => {
    const d = new Date().toISOString().slice(0,10);
    return `
      <div>
        <h2 class="text-2xl font-semibold mb-4">Attendance Log</h2>
        <div class="card p-4 rounded">
          <div class="flex gap-3 mb-4">
            <input id="log-date" type="date" value="${d}" class="p-2 rounded bg-[color:inherit]">
            <button id="download-csv" class="p-2 rounded bg-green-600 text-white">Download CSV</button>
            <button id="clear-attendance" class="p-2 rounded bg-red-600 text-white">Clear All</button>
          </div>
          <div class="overflow-auto"><table class="w-full"><thead><tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Date</th><th class="p-2 text-left">Subject</th><th class="p-2 text-left">Time</th><th class="p-2 text-left">Status</th></tr></thead><tbody id="log-body"></tbody></table></div>
        </div>
      </div>
    `;
  },

  settings: () => {
    return `
      <div>
        <h2 class="text-2xl font-semibold mb-4">Settings</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="card p-4 rounded">
            <h3 class="font-semibold mb-2">Admin</h3>
            <form id="cred-form" class="space-y-2">
              <input id="cur-pass" placeholder="Current password" type="password" class="w-full p-2 rounded bg-[color:inherit]" required>
              <input id="new-user" placeholder="New username" class="w-full p-2 rounded bg-[color:inherit]" required>
              <input id="new-pass" placeholder="New password" type="password" class="w-full p-2 rounded bg-[color:inherit]" required>
              <button class="w-full p-2 rounded bg-[color:var(--accent)] text-white" type="submit">Save</button>
            </form>
          </section>
          <section class="card p-4 rounded">
            <h3 class="font-semibold mb-2">Danger Zone</h3>
            <div class="space-y-2">
              <button id="clear-users" class="w-full p-2 rounded bg-red-600 text-white">Delete All Students</button>
            </div>
          </section>
        </div>
      </div>
    `;
  },

  clock: () => {
    return `
      <div>
        <h2 class="text-2xl font-semibold mb-4">Clock In / Out</h2>
        <div class="card p-4 rounded">
          <div id="session-setup">
            <input id="subject" placeholder="Subject name" class="w-full p-2 rounded bg-[color:inherit]"><button id="start-btn" class="mt-3 w-full p-2 rounded bg-[color:var(--accent)] text-white">Start Session</button>
          </div>

          <div id="session-run" class="hidden mt-4 space-y-3">
            <div class="flex justify-between items-center">
              <div><strong>Subject:</strong> <span id="active-subject"></span></div>
              <div class="flex gap-2">
                <button id="stop-btn" class="p-2 rounded bg-red-600 text-white">Stop</button>
                <button id="pause-btn" class="p-2 rounded bg-gray-600 text-white">Pause</button>
              </div>
            </div>

            <div class="relative w-full" style="padding-top:56%;background:var(--card);border-radius:8px;overflow:hidden">
              <video id="video" autoplay muted playsinline style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover"></video>
              <canvas id="overlay" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
            </div>

            <div id="recognition-log" class="max-h-48 overflow-auto p-2 text-sm"></div>
          </div>
        </div>
      </div>
    `;
  }
};

function showPage(page){
  if(page !== 'dashboard' && !STATE.modelsLoaded){
    showAlert('Please wait','Face models are still loading');
    return;
  }
  const content = templates[page] ? templates[page]() : '<div>Not found</div>';
  els.main.innerHTML = content;
  document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('opacity-70', a.dataset.page !== page));
  // Hook page-specific setup
  if(page === 'users') setupUsersPage();
  if(page === 'logs') setupLogsPage();
  if(page === 'settings') setupSettingsPage();
  if(page === 'clock') setupClockPage();
  if(page === 'dashboard') {} // nothing else
}

/* ========= Users Page Logic ========= */
function setupUsersPage(){
  renderUserList();

  const form = document.getElementById('add-user-form');
  const fileInput = document.getElementById('file-image');
  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const name = document.getElementById('name').value.trim();
    const roll = document.getElementById('roll').value.trim();
    if(!name || !roll) { showAlert('Error','Name and roll required'); return; }
    if(STATE.users.some(u=>u.roll === roll)){ showAlert('Error','Roll exists'); return; }

    // choose source: file or captured image
    const file = fileInput.files && fileInput.files[0];
    let imgElement;
    try{
      showLoading('Processing','Detecting face...');
      if(file){
        imgElement = await faceapi.bufferToImage(file);
      } else if(lastSnapDataUrl){
        imgElement = await faceapi.fetchImage(lastSnapDataUrl);
      } else {
        showAlert('Error','Upload an image or capture via webcam');
        return;
      }
      const detection = await faceapi.detectSingleFace(imgElement).withFaceLandmarks().withFaceDescriptor();
      if(!detection){ showAlert('No face','Could not detect a face'); return; }
      const descriptorArr = Array.from(detection.descriptor);
      const dataUrl = file ? await fileToDataURL(file) : lastSnapDataUrl;
      const user = { id: Date.now().toString(), name, roll, image: dataUrl, descriptor: descriptorArr };
      STATE.users.push(user); saveDB(); rebuildMatcher(); renderUserList();
      showAlert('Added', `${name} added`);
      form.reset(); lastSnapDataUrl = null;
      stopCaptureIfAny();
    }catch(err){
      console.error(err); showAlert('Error','Failed to add student');
    }finally{ hideLoading(); }
  });

  // webcam capture flow
  const capBtn = document.getElementById('capture-btn');
  capBtn.addEventListener('click', startCapture);
  document.getElementById('snap').addEventListener('click', snapAndShow);
  document.getElementById('stop-capture').addEventListener('click', stopCaptureIfAny);

  document.getElementById('export-db').addEventListener('click', exportJSON);
  document.getElementById('import-db').addEventListener('click', ()=> document.getElementById('import-file').click());
  document.getElementById('import-file').addEventListener('change', importJSONFromFile);
}

function renderUserList(){
  const list = document.getElementById('user-list');
  if(!list) return;
  if(STATE.users.length === 0){ list.innerHTML = '<div class="text-[color:var(--muted)]">No students</div>'; return; }
  list.innerHTML = STATE.users.map(u => `
    <div data-id="${u.id}" class="p-2 rounded bg-[color:var(--card)] text-center">
      <img src="${u.image}" alt="${u.name}" class="w-16 h-16 rounded-full mx-auto object-cover">
      <div class="text-xs mt-2 font-semibold truncate">${u.name}</div>
      <div class="text-xs text-[color:var(--muted)]">Roll: ${u.roll}</div>
      <div class="flex gap-2 mt-2">
        <button class="delete btn bg-red-600 text-white small" data-id="${u.id}">Delete</button>
        <button class="analytics btn bg-gray-600 text-white small" data-id="${u.id}">Analytics</button>
      </div>
    </div>
  `).join('');

  // delegates
  list.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async (e)=>{
    const id = btn.dataset.id;
    if(await showConfirm('Delete student?')){ STATE.users = STATE.users.filter(s=>s.id!==id); saveDB(); rebuildMatcher(); renderUserList(); showAlert('Deleted','Student removed'); }
  }));

  list.querySelectorAll('.analytics').forEach(btn=> btn.addEventListener('click', (e)=>{
    const id = btn.dataset.id; showAnalytics(id);
  }));
}

/* ========= Webcam capture for adding user ========= */
let captureStream = null;
let lastSnapDataUrl = null;
async function startCapture(){
  const area = document.getElementById('capture-area'); area.classList.remove('hidden');
  const vid = document.getElementById('capture-video');
  try{
    captureStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
    vid.srcObject = captureStream;
    vid.onloadedmetadata = ()=> vid.play();
  }catch(e){
    console.error(e); showAlert('Camera','Cannot access camera');
  }
}
function stopCaptureIfAny(){
  const area = document.getElementById('capture-area'); area.classList.add('hidden');
  if(captureStream){ captureStream.getTracks().forEach(t=>t.stop()); captureStream = null; }
}
function snapAndShow(){
  const vid = document.getElementById('capture-video');
  const c = document.getElementById('capture-canvas');
  c.width = vid.videoWidth; c.height = vid.videoHeight;
  const ctx = c.getContext('2d'); ctx.drawImage(vid,0,0,c.width,c.height);
  lastSnapDataUrl = c.toDataURL('image/jpeg', 0.9);
  // show small flash
  showAlert('Captured','Image captured. Submit the form to add student.');
}

/* ========= File utility ========= */
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* ========= Export / Import ========= */
function exportJSON(){
  const payload = { users: STATE.users, attendance: STATE.attendance };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendwise_export_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importJSONFromFile(e){
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    try{
      const parsed = JSON.parse(r.result);
      if(Array.isArray(parsed.users) && Array.isArray(parsed.attendance)){
        STATE.users = parsed.users; STATE.attendance = parsed.attendance; saveDB(); rebuildMatcher(); renderUserList(); showAlert('Imported','Database imported');
      } else showAlert('Invalid','JSON structure not recognized');
    }catch(err){ showAlert('Error','Invalid JSON'); }
  };
  r.readAsText(f);
}

/* ========= Logs Page ========= */
function setupLogsPage(){
  document.getElementById('log-date').addEventListener('change', renderLogs);
  document.getElementById('download-csv').addEventListener('click', downloadCSV);
  document.getElementById('clear-attendance').addEventListener('click', async ()=>{
    if(await showConfirm('Clear all attendance?')){ STATE.attendance = []; saveDB(); renderLogs(); showAlert('Cleared','Attendance cleared'); }
  });
  renderLogs();
}
function renderLogs(){
  const date = document.getElementById('log-date').value;
  const rows = STATE.attendance.filter(a => a.date === date);
  const tbody = document.getElementById('log-body');
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-[color:var(--muted)]">No records</td></tr>'; return; }
  tbody.innerHTML = rows.map(r => `<tr><td class="p-2">${r.name}</td><td class="p-2">${r.date}</td><td class="p-2">${r.subject}</td><td class="p-2">${r.time}</td><td class="p-2">${r.status}</td></tr>`).join('');
}
function downloadCSV(){
  const date = document.getElementById('log-date').value;
  const rows = STATE.attendance.filter(a => a.date === date);
  if(!rows.length){ showAlert('No data','No records for chosen date'); return; }
  const headers = ['Name','Date','Subject','Time','Status'];
  const csv = [headers.join(',')].concat(rows.map(r=>`"${r.name}","${r.date}","${r.subject}","${r.time}","${r.status}"`)).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendance_${date}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ========= Settings Page ========= */
function setupSettingsPage(){
  const form = document.getElementById('cred-form');
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const cur = document.getElementById('cur-pass').value;
    if(cur !== localStorage.getItem('adminPass')){ showAlert('Error','Current password incorrect'); return; }
    const nu = document.getElementById('new-user').value.trim();
    const np = document.getElementById('new-pass').value;
    localStorage.setItem('adminUser', nu); localStorage.setItem('adminPass', np); form.reset(); showAlert('Saved','Credentials updated');
  });

  document.getElementById('clear-users').addEventListener('click', async ()=>{
    if(await showConfirm('Delete all students? This cannot be undone.')){ STATE.users = []; saveDB(); rebuildMatcher(); showAlert('Cleared','All students deleted'); showPage('users'); }
  });
}

/* ========= Clock / Recognition Page ========= */
function setupClockPage(){
  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const pauseBtn = document.getElementById('pause-btn');

  startBtn.addEventListener('click', startSession);
  stopBtn.addEventListener('click', stopSession);
  pauseBtn.addEventListener('click', ()=> {
    if(STATE.recogInterval){ clearInterval(STATE.recogInterval); STATE.recogInterval = null; pauseBtn.textContent = 'Resume'; } else { runRecognition(); pauseBtn.textContent = 'Pause'; }
  });
}

async function startSession(){
  if(!STATE.faceMatcher){ showAlert('No students','Register students first'); return; }
  const subj = document.getElementById('subject').value.trim();
  if(!subj){ showAlert('Error','Subject required'); return; }
  document.getElementById('active-subject').textContent = subj;
  document.getElementById('session-setup').classList.add('hidden');
  document.getElementById('session-run').classList.remove('hidden');
  await startVideoRecognition();
}

async function startVideoRecognition(){
  try{
    const vid = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
    vid.srcObject = stream; STATE.videoStream = stream;
    await vid.play();
    resizeOverlay();
    runRecognition();
  }catch(e){
    console.error(e); showAlert('Camera','Could not access camera'); stopSession();
  }
}

function stopSession(){
  stopRecognition();
  document.getElementById('session-run').classList.add('hidden');
  document.getElementById('session-setup').classList.remove('hidden');
}

function stopRecognition(){
  if(STATE.recogInterval){ clearInterval(STATE.recogInterval); STATE.recogInterval = null; }
  const vid = document.getElementById('video');
  if(vid && vid.srcObject){ vid.srcObject.getTracks().forEach(t=>t.stop()); vid.srcObject = null; }
  STATE.videoStream = null;
  STATE.verifying = false;
  STATE.pendingUser = null;
}

function resizeOverlay(){
  const vid = document.getElementById('video'), canvas = document.getElementById('overlay');
  if(!vid || !canvas) return;
  canvas.width = vid.videoWidth || vid.clientWidth;
  canvas.height = vid.videoHeight || vid.clientHeight;
}

/* ---------- Recognition loop ---------- */
function runRecognition(){
  const vid = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  STATE.recogInterval = setInterval(async ()=>{
    if(!STATE.videoStream || STATE.verifying) return;
    try{
      const detections = await faceapi.detectAllFaces(vid).withFaceLandmarks().withFaceDescriptors();
      if(!detections || !detections.length){ ctx.clearRect(0,0,canvas.width,canvas.height); return; }
      const resized = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
      ctx.clearRect(0,0,canvas.width,canvas.height);
      resized.forEach(det => {
        const box = det.detection.box;
        ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.strokeRect(box.x, box.y, box.width, box.height);
        if(STATE.faceMatcher){
          const best = STATE.faceMatcher.findBestMatch(det.descriptor);
          const label = best.label;
          ctx.fillStyle = '#00000099'; const txt = label === 'unknown' ? 'Unknown' : label;
          ctx.fillRect(box.x, box.y + box.height - 18, Math.min(140, box.width), 18);
          ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif'; ctx.fillText(txt, box.x + 6, box.y + box.height - 4);
          if(label !== 'unknown') attemptVerify(label);
        }
      });
    }catch(e){
      console.error('recog err', e);
    }
  }, 900);
}

/* ---------- Verification / PIN ---------- */
function attemptVerify(name){
  const subj = document.getElementById('active-subject').textContent || '';
  const key = `${name}|${subj}`;
  const now = Date.now();
  if(STATE.cooldownMap.has(key) && now - STATE.cooldownMap.get(key) < 30_000) return; // 30s cooldown
  // Check if already marked today for same subject
  const today = new Date().toISOString().slice(0,10);
  if(STATE.attendance.find(a=>a.name===name && a.date===today && a.subject.toLowerCase()===subj.toLowerCase())){
    appendLog(`${name} already clocked for ${subj}`, 'text-[color:var(--muted)]'); STATE.cooldownMap.set(key, now); return;
  }
  // trigger PIN flow
  if(STATE.verifying) return;
  STATE.pendingUser = STATE.users.find(u=>u.name === name);
  if(!STATE.pendingUser) return;
  STATE.verifying = true;
  STATE.cooldownMap.set(key, now);
  els.pinName.textContent = name;
  els.pinInput.value = '';
  els.pinErr.textContent = '';
  els.pinModal.classList.remove('hidden');
  els.pinInput.focus();
  // set a timeout to auto-cancel
  STATE.pinTimeout = setTimeout(()=>{ if(STATE.verifying) cancelPin(); }, 15_000);
}

function cancelPin(){
  STATE.verifying = false; STATE.pendingUser = null; els.pinModal.classList.add('hidden'); if(STATE.pinTimeout){ clearTimeout(STATE.pinTimeout); STATE.pinTimeout = null; }
}
async function submitPin(e){
  e.preventDefault();
  if(!STATE.pendingUser){ cancelPin(); return; }
  const v = els.pinInput.value.trim();
  if(v === STATE.pendingUser.roll){
    await markAttendance(STATE.pendingUser.name);
    cancelPin();
  } else {
    els.pinErr.textContent = 'Incorrect roll';
    setTimeout(()=> els.pinErr.textContent = '', 1500);
    els.pinInput.value = '';
    els.pinInput.focus();
  }
}

/* ---------- Mark Attendance ---------- */
async function markAttendance(name){
  const now = new Date();
  const subj = document.getElementById('active-subject').textContent || '';
  const record = {
    id: Date.now().toString(),
    name,
    subject: subj,
    date: now.toISOString().slice(0,10),
    time: now.toLocaleTimeString(),
    status: now.getHours() < 9 ? 'Present' : 'Late'
  };
  STATE.attendance.push(record);
  saveDB();
  appendLog(`[${record.time}] ${name} - ${record.status}`, 'text-green-400');
}

/* ---------- Recognition log helper ---------- */
function appendLog(msg, cls='text-[color:var(--muted)]'){
  const el = document.getElementById('recognition-log');
  if(!el) return;
  const d = document.createElement('div'); d.className = cls; d.textContent = msg;
  el.prepend(d);
  while(el.children.length > 40) el.removeChild(el.lastChild);
}

/* ========= Utilities: Analytics ========= */
function showAnalytics(id){
  const user = STATE.users.find(u=>u.id === id); if(!user) return;
  const uAtt = STATE.attendance.filter(a=>a.name === user.name);
  const totalSessions = [...new Set(STATE.attendance.map(a=>a.date+'|'+a.subject))].length;
  const attended = [...new Set(uAtt.map(a=>a.date+'|'+a.subject))].length;
  const pct = totalSessions === 0 ? '0.0' : ((attended / totalSessions) * 100).toFixed(1);
  showAlert('Analytics', `${user.name}: ${pct}% (${attended} of ${totalSessions})\nRecent:\n${uAtt.slice(-5).reverse().map(a=>`${a.date} — ${a.subject} — ${a.status}`).join('\n') || 'No records'}`);
}

/* ========= Misc ========= */
function toggleTheme(){
  const html = document.documentElement; html.classList.toggle('light');
  const ic = document.getElementById('theme-icon'); ic.classList.toggle('fa-moon'); ic.classList.toggle('fa-sun');
}

/* ========= On-load: rebuild matcher from persisted users ========= */
function rebuildMatcherFromLoad(){
  // convert any stored descriptors (arrays) to Float32 when building matcher
  rebuildMatcher();
}

/* ========= Utilities: small ========= */
function showPageAndEnsureAuth(page){
  if(localStorage.getItem('isLoggedIn') !== 'true'){ showAlert('Not authenticated','Please login'); return; }
  showPage(page);
}

/* Run once to ensure DB loaded and matcher ready */
loadDB();
rebuildMatcher();

/* Expose small helpers for possible debugging in console */
window._attendwise = { STATE, loadDB, saveDB, rebuildMatcher };

/* ---------- End of script ---------- */
</script>

</body>
</html>